<canvas id="matrix-canvas"></canvas>

<script>
    const canvas = document.getElementById("matrix-canvas") as HTMLCanvasElement;
    const ctx = canvas.getContext("2d") as CanvasRenderingContext2D;

    let width = 0;
    let height = 0;

    interface Snowflake {
        x: number;
        y: number;
        baseX: number;
        speedY: number;
        size: number;
        angle: number;
        angularSpeed: number;
        depth: number;
    }

    let snowflakes: Snowflake[] = [];

    const char = "❄️";

    let cachedColor = "";
    let darkMode = document.body.classList.contains("dark");

    const WIND_STRENGTH = 0.6;
    const WAVE_AMPLITUDE = 8;

    function getFlakeCount() {
        const area = window.innerWidth * window.innerHeight;
        const density = 1 / 12000;
        return Math.floor(area * density);
    }

    function updateColor() {
        const style = getComputedStyle(document.body);
        cachedColor = style.getPropertyValue("--color-background").trim();
        darkMode = document.body.classList.contains("dark");
    }

    function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;

        const numFlakes = getFlakeCount();

        snowflakes = Array.from({ length: numFlakes }, () => {
            const depth = Math.random();
            const x = Math.random() * width;

            return {
                x,
                baseX: x,
                y: Math.random() * height,
                speedY: 0.2 + depth * 0.6,
                size: 10 + depth * 10,
                angle: Math.random() * Math.PI * 2,
                angularSpeed: 0.004 + depth * 0.015,
                depth
            };
        });
    }

    function draw() {
        if (cachedColor) {
            ctx.globalAlpha = 0.5;
            ctx.fillStyle = cachedColor;
            ctx.fillRect(0, 0, width, height);
        } else {
            ctx.clearRect(0, 0, width, height);
        }

        for (const flake of snowflakes) {
            flake.y += flake.speedY;

            flake.baseX += WIND_STRENGTH * (0.3 + flake.depth);

            flake.angle += flake.angularSpeed;
            flake.x = flake.baseX + Math.sin(flake.angle) * WAVE_AMPLITUDE * (0.3 + flake.depth);

            if (flake.x > width + 30) flake.baseX = -30;

            if (flake.y > height) {
                flake.y = -flake.size;
                flake.baseX = Math.random() * width;
            }

            ctx.globalAlpha = darkMode ? 0.35 : 0.75;
            ctx.font = `${flake.size}px serif`;
            ctx.fillText(char, flake.x, flake.y);
        }

        requestAnimationFrame(draw);
    }

    updateColor();
    resize();

    window.addEventListener("resize", resize);

    const observer = new MutationObserver(() => updateColor());
    observer.observe(document.body, { attributes: true });

    requestAnimationFrame(draw);
</script>

<style>
    #matrix-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        pointer-events: none;
        z-index: -1;
    }

    @media (prefers-reduced-motion: reduce) {
        #matrix-canvas {
            display: none;
        }
    }
</style>
