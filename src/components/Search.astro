---
import { SearchWidget, type FrontmatterData } from "./search/SearchWidget.tsx";
import type { TeaserProps } from "./search/Teaser.tsx";
import { getEntry } from "astro:content";
import { getDependencyCollection } from "../data";

interface Props {
    showAllOnEmpty: boolean;
    pathPrefix: string;
}

const { showAllOnEmpty, pathPrefix } = Astro.props;

const allDependencies = await getDependencyCollection();
const searchTiles: FrontmatterData[] = allDependencies.map(dependency => ({
    name: dependency.data.name,
    description: dependency.data.description,
    type: dependency.data.type
}));

const tiles: TeaserProps[] = [];

for (const tile of searchTiles) {
    const npmData = await getEntry("npmData", tile.name);

    if (!npmData) {
        throw new Error(`No npmData found for ${tile.name}`);
    }

    tiles.push({
        ...tile,
        downloads: npmData.data.downloads,
        dependencies: npmData.data.dependencies[0],
        distinctDependencies: npmData.data.dependencies[1],
        pathPrefix
    });
}
---

<SearchWidget client:load tiles={tiles} showAllOnEmpty={showAllOnEmpty} />
